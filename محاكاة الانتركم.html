<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>محاكي توصيل الانتركم – V2 (تعليمي/فني)</title>
  <style>
    :root{--bg:#0f1115;--panel:#171923;--ink:#e8e8ef;--muted:#a6adbb;--brand:#4dd0e1;--line:#6b7280;--ok:#34d399;--warn:#fbbf24;--err:#f87171;--plan:#c084fc}
    *{box-sizing:border-box}html,body{height:100%}body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 system-ui,Segoe UI,Roboto,Arial}
    .wrap{display:grid;grid-template-columns:340px 1fr;gap:12px;max-width:1280px;margin:0 auto;padding:12px}
    .panel{background:var(--panel);border:1px solid #ffffff14;border-radius:14px;padding:12px}
    .h{font-weight:700;margin:6px 0 10px}
    .btn{appearance:none;background:#ffffff10;border:1px solid #ffffff1a;border-radius:10px;color:var(--ink);padding:8px 10px;cursor:pointer}
    .btn:hover{border-color:#ffffff33}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .small{font-size:12px;color:var(--muted)}
    .input,select{background:#10121a;border:1px solid #ffffff1a;border-radius:10px;color:var(--ink);padding:8px}
    .canvas{position:relative;height:580px;background:#0a0c12;border:1px solid #ffffff14;border-radius:14px;overflow:hidden}
    .node{position:absolute;border-radius:12px;border:1px solid #ffffff22;box-shadow:0 2px 8px #0008;padding:8px 10px;cursor:move;user-select:none}
    .sel{border-color:#ffd166}
    .node .t{font-weight:700}
    .chips{position:absolute;left:8px;right:8px;bottom:6px;display:flex;gap:6px;flex-wrap:wrap}
    .chip{background:#ffffff14;border:1px solid #ffffff1a;border-radius:999px;padding:4px 8px}
    .ok{color:var(--ok)}.warn{color:var(--warn)}.err{color:var(--err)}
    table{width:100%;border-collapse:collapse}td,th{border-bottom:1px solid #ffffff14;padding:6px}
    .legend span{display:inline-block;margin-left:10px}
    .legend i{display:inline-block;width:10px;height:10px;margin-left:4px;border-radius:3px;background:#fff}
    .badge{font-size:11px;border:1px solid #ffffff22;border-radius:8px;padding:2px 6px;background:#ffffff10}
    .toggle{display:inline-flex;align-items:center;gap:6px}
    .plan{stroke:var(--plan);stroke-dasharray:6 6;opacity:.8}
    .hint{position:absolute;padding:6px 8px;background:#000c;border:1px solid #ffffff22;border-radius:8px;pointer-events:none;transform:translate(-50%,-120%);white-space:nowrap}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Sidebar -->
    <aside class="panel" id="sidebar">
      <div class="h">الوضع</div>
      <div class="row">
        <label class="toggle"><input type="checkbox" id="teachMode"> <span>وضع التعليم/الفني</span></label>
        <label class="toggle"><input type="checkbox" id="showPlan"> <span>إظهار المخطط الصحيح</span></label>
      </div>

      <div class="h">قوالب جاهزة</div>
      <div class="row">
        <button class="btn" id="presetIP">IP‑PoE (باب واحد)</button>
        <button class="btn" id="preset2W">2‑Wire (أساسي)</button>
      </div>

      <div class="h">أضف جهاز</div>
      <div class="grid2" id="toolbox"></div>

      <div class="h">التوصيل السريع</div>
      <div class="row">
        <select id="connType">
          <option value="Data">بيانات / إيثرنت</option>
          <option value="Power">طاقة 12V (سلكين)</option>
          <option value="Relay">ريلاي فتح الباب</option>
          <option value="2Wire">ناقل ثنائي (2‑Wire)</option>
        </select>
        <input id="connLen" class="input" type="number" min="0" step="1" value="10" style="width:80px"/>
        <span class="small">متر</span>
      </div>
      <div class="small" style="margin-top:6px">انقر جهازين متتاليين لرسم كابل. لإلغاء، انقر مساحة فارغة.</div>

      <div class="h">المساعدة السريعة (ألوان الأسلاك)</div>
      <div class="small">
        <b>RJ45 TIA/EIA‑568B:</b> أبيض/برتقالي، برتقالي، أبيض/أخضر، أزرق، أبيض/أزرق، أخضر، أبيض/بني، بني.<br/>
        <b>Power 12V:</b> أحمر (+)، أسود (−).<br/>
        <b>2‑Wire Bus:</b> أحمر/أسود (لا تُعكس القطبية إذا اشترط الدليل).<br/>
        <b>Relay:</b> وصل NO + COM على مسار القفل.
      </div>

      <div class="h">محاكاة</div>
      <div class="row">
        <button class="btn" id="simulate">تشغيل المحاكاة</button>
        <button class="btn" id="resetSim">إيقاف</button>
      </div>

      <div class="h">حفظ/تحميل</div>
      <div class="row">
        <button class="btn" id="exportBtn">تصدير JSON</button>
        <label class="btn" for="importFile">استيراد JSON</label>
        <input id="importFile" type="file" accept="application/json" style="display:none"/>
      </div>

      <div class="h">قائمة المكونات (BOM)</div>
      <div class="small">أجهزة</div>
      <table id="bomDevices"><tbody></tbody></table>
      <div class="small" style="margin-top:8px">كابلات</div>
      <table id="bomCables"><tbody></tbody></table>
    </aside>

    <!-- Main -->
    <main>
      <section class="panel">
        <div class="row" style="align-items:center">
          <div class="h" style="margin:0">منطقة الرسم</div>
          <span class="small" style="margin-inline-start:auto">اسحب لتحريك – انقر للتوصيل – انقر خارج لإلغاء.</span>
          <button class="btn" id="deleteNode">حذف الجهاز المحدد</button>
          <button class="btn" id="applyPlan">تطبيق التوصيات</button>
        </div>
        <div class="legend small" style="margin:8px 0 12px">
          <span><i style="background:#60a5fa"></i> بيانات</span>
          <span><i style="background:#34d399"></i> طاقة</span>
          <span><i style="background:#f59e0b"></i> ريلاي</span>
          <span><i style="background:#a78bfa"></i> 2‑Wire</span>
          <span class="badge">المخطط الصحيح يظهر بخط أرجواني متقطع</span>
        </div>
        <div class="canvas" id="canvas">
          <svg id="wires" width="100%" height="100%" style="position:absolute;inset:0;pointer-events:none">
            <defs>
              <marker id="arrow" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
                <path d="M 0 0 L 10 5 L 0 10 z" fill="#9aa0a6"/>
              </marker>
            </defs>
          </svg>
          <div class="chips" id="chips"></div>
          <div id="hint" class="hint" style="display:none"></div>
        </div>
      </section>

      <section class="panel">
        <div class="h">الأخطاء والتنبيهات</div>
        <ul id="issues" style="margin:0;padding-inline-start:18px"></ul>
      </section>

      <section class="panel">
        <div class="h">التوصيلات</div>
        <div id="connsList" class="row"></div>
      </section>
    </main>
  </div>

<script>
// ====== Data Model (V2) ======
const NET = { IP:'IP', TWO_WIRE:'2WIRE' };
const DEV = {
  DoorStationIP:  {label:'لوحة باب (IP)',      network:NET.IP,      color:'#f59e0b', w:160,h:68,
                   ports:[{id:'ETH',label:'RJ45 (Data/PoE)', role:'data', dir:'io', poe_in:true},
                          {id:'RELAY',label:'Relay Out (NO/COM)', role:'relay_out', dir:'out'}]},
  IndoorMonitorIP:{label:'شاشة داخلية (IP)',   network:NET.IP,      color:'#38bdf8', w:180,h:68,
                   ports:[{id:'ETH',label:'RJ45 (Data/PoE)', role:'data', dir:'io', poe_in:true},
                          {id:'RELAY',label:'Relay Out (NO/COM)', role:'relay_out', dir:'out'}]},
  PoESwitch:      {label:'سويتش PoE',          network:NET.IP,      color:'#10b981', w:160,h:56,
                   ports:[{id:'SW',label:'Switch Ports (PoE)', role:'data_poe', dir:'io', poe_out:true}]},
  Router:         {label:'راوتر/شبكة',         network:NET.IP,      color:'#047857', w:150,h:56,
                   ports:[{id:'LAN',label:'LAN', role:'data', dir:'io'}]},
  PSU12V:         {label:'مزود طاقة 12V',      network:null,        color:'#6b7280', w:150,h:56,
                   ports:[{id:'VOUT',label:'12V (+/−) OUT', role:'power_out', dir:'out'}]},
  ElectricStrike: {label:'قفل كهربائي Strike', network:null,        color:'#a21caf', w:170,h:68,
                   ports:[{id:'VIN',label:'12V (+/−) IN', role:'lock_power_in', dir:'in'}]},
  DoorStation2W:  {label:'لوحة باب (2‑Wire)',  network:NET.TWO_WIRE,color:'#b45309', w:170,h:68,
                   ports:[{id:'BUS',label:'2‑Wire Bus', role:'bus2w', dir:'io'},
                          {id:'RELAY',label:'Relay Out (NO/COM)', role:'relay_out', dir:'out'}]},
  IndoorMonitor2W:{label:'شاشة (2‑Wire)',       network:NET.TWO_WIRE,color:'#0369a1', w:170,h:68,
                   ports:[{id:'BUS',label:'2‑Wire Bus', role:'bus2w', dir:'io'},
                          {id:'RELAY',label:'Relay Out (NO/COM)', role:'relay_out', dir:'out'}]}
};

const COLORS = { Data:'#60a5fa', Power:'#34d399', Relay:'#f59e0b', '2Wire':'#a78bfa' };
const CABLE_GROUP = { Data:'Ethernet (8C)', Power:'Power 2C', Relay:'Relay 2C', '2Wire':'Bus 2C' };
const uid = () => Math.random().toString(36).slice(2,9);

let state = { nodes:[], conns:[], selected:null, pendingFrom:null, simPath:new Set(), teach:false, plan:false };

const els = {
  canvas: document.getElementById('canvas'),
  svg: document.getElementById('wires'),
  issues: document.getElementById('issues'),
  connsList: document.getElementById('connsList'),
  chips: document.getElementById('chips'),
  toolbox: document.getElementById('toolbox'),
  bomDev: document.getElementById('bomDevices').querySelector('tbody'),
  bomCab: document.getElementById('bomCables').querySelector('tbody'),
  connType: document.getElementById('connType'),
  connLen: document.getElementById('connLen'),
  teachMode: document.getElementById('teachMode'),
  showPlan: document.getElementById('showPlan'),
  applyPlan: document.getElementById('applyPlan'),
  hint: document.getElementById('hint')
};

// ====== Presets ======
function presetIPPoe(){
  const d1 = {id:uid(), type:'DoorStationIP',  name:'لوحة الباب',   x:120, y:260};
  const d2 = {id:uid(), type:'IndoorMonitorIP',name:'شاشة داخلية',  x:520, y:260};
  const sw = {id:uid(), type:'PoESwitch',      name:'سويتش PoE',    x:320, y:110};
  const rt = {id:uid(), type:'Router',         name:'راوتر',        x:320, y:30};
  const lk = {id:uid(), type:'ElectricStrike', name:'قفل 12V',      x:820, y:260};
  const ps = {id:uid(), type:'PSU12V',         name:'مزود 12V',     x:820, y:130};
  return {nodes:[d1,d2,sw,rt,lk,ps], conns:[]};
}
function preset2Wire(){
  const d1 = {id:uid(), type:'DoorStation2W',  name:'لوحة (2W)',    x:120, y:260};
  const d2 = {id:uid(), type:'IndoorMonitor2W',name:'شاشة (2W)',    x:520, y:260};
  const lk = {id:uid(), type:'ElectricStrike', name:'قفل 12V',      x:820, y:260};
  const ps = {id:uid(), type:'PSU12V',         name:'مزود 12V',     x:820, y:130};
  return {nodes:[d1,d2,lk,ps], conns:[]};
}

// ====== Storage ======
function saveLocal(){ localStorage.setItem('intercom_mvp_v2', JSON.stringify({nodes:state.nodes, conns:state.conns})); }
function loadLocal(){ const s=localStorage.getItem('intercom_mvp_v2'); if(s){ try{const o=JSON.parse(s); if(o.nodes&&o.conns){state.nodes=o.nodes; state.conns=o.conns;} }catch(e){} } }

// ====== Helpers ======
function centerOf(n){ const def=DEV[n.type]; return {cx:n.x+def.w/2, cy:n.y+def.h/2}; }
function nodeById(id){ return state.nodes.find(n=>n.id===id); }
function roleSet(n){ return new Set(DEV[n.type].ports.map(p=>p.role)); }
function hasRole(n, role){ return DEV[n.type].ports.some(p=>p.role===role); }
function portForType(n, type, side){
  const ports = DEV[n.type].ports;
  switch(type){
    case 'Data':   return (ports.find(p=>p.role==='data'||p.role==='data_poe')||ports[0])?.id;
    case '2Wire':  return (ports.find(p=>p.role==='bus2w')||ports[0])?.id;
    case 'Relay':  return side==='src' ? (ports.find(p=>p.role==='relay_out')||ports[0])?.id : (ports.find(p=>p.role==='lock_power_in')||ports[0])?.id;
    case 'Power':  return side==='src' ? (ports.find(p=>p.role==='power_out')||ports[0])?.id : (ports.find(p=>p.role==='lock_power_in')||ports[0])?.id;
    default: return ports[0]?.id;
  }
}

// Build suggested plan for current topology
function suggestPlan(){
  const out=[];
  const byType = (t)=> state.nodes.filter(n=>n.type===t);
  const any = (arr)=> arr.length? arr[0] : null;

  const sw = any(byType('PoESwitch'));
  const rt = any(byType('Router'));
  const lock = any(byType('ElectricStrike'));
  const psu = any(byType('PSU12V'));

  const ipDoors = byType('DoorStationIP');
  const ipMons  = byType('IndoorMonitorIP');
  if(sw){
    for(const d of ipDoors){ out.push({type:'Data', a:d.id, b:sw.id, reason:'Door ↔ PoE Switch', poe:true}); }
    for(const m of ipMons){ out.push({type:'Data', a:m.id, b:sw.id, reason:'Monitor ↔ PoE Switch', poe:true}); }
    if(rt) out.push({type:'Data', a:sw.id, b:rt.id, reason:'Switch ↔ Router'});
  }
  const d2 = any(byType('DoorStation2W'));
  const m2 = any(byType('IndoorMonitor2W'));
  if(d2 && m2){ out.push({type:'2Wire', a:d2.id, b:m2.id, reason:'Door (2W) ↔ Monitor (2W)'}); }

  const monAny = ipMons[0] || m2;
  if(lock && monAny){ out.push({type:'Relay', a:monAny.id, b:lock.id, reason:'Monitor Relay → Strike'}); }
  if(lock && psu){ out.push({type:'Power', a:psu.id, b:lock.id, reason:'PSU → Strike Power'}); }

  for(const s of out){
    const A=nodeById(s.a), B=nodeById(s.b);
    s.pa = portForType(A, s.type, 'src');
    s.pb = portForType(B, s.type, 'dst');
    s.length = Math.max(3, Math.round(distance(A,B)/50)*5);
    if(s.type==='Data' && (A.type==='PoESwitch'||B.type==='PoESwitch')) s.poe=true;
  }
  return out;
}

function distance(a,b){ const {cx:ax,cy:ay}=centerOf(a); const {cx:bx,cy:by}=centerOf(b); return Math.hypot(ax-bx, ay-by); }

// ====== Validation ======
function validate(){
  const msgs=[];
  function add(level, text, fix){ msgs.push({lvl:level, text, fix}); }
  const dataOK = (n)=> hasRole(n,'data') || hasRole(n,'data_poe');
  const busOK  = (n)=> hasRole(n,'bus2w');

  for(const c of state.conns){
    const A=nodeById(c.a), B=nodeById(c.b); if(!A||!B) continue;
    if(c.type==='Data'){
      if(!(dataOK(A)&&dataOK(B))) add('err', `توصيل بيانات غير صحيح بين "${A.name}" و"${B.name}" — يجب RJ45/شبكة على الطرفين.`, suggestClosest('Data',A,B));
      if(Number(c.length)>100) add('warn', `طول كابل الإيثرنت (${c.length}م) يتجاوز 100م.`);
    }
    if(c.type==='2Wire'){
      if(!(busOK(A)&&busOK(B))) add('err', `توصيل 2‑Wire غير صحيح بين "${A.name}" و"${B.name}" — استخدم ناقل ثنائي فقط لأجهزة 2‑Wire.`, suggestClosest('2Wire',A,B));
    }
    if(c.type==='Relay'){
      const ok = (hasRole(A,'relay_out') && hasRole(B,'lock_power_in')) || (hasRole(B,'relay_out') && hasRole(A,'lock_power_in'));
      if(!ok) add('err', `ريلاي غير صحيح بين "${A.name}" و"${B.name}" — يجب أن يخرج من جهاز بورت Relay Out إلى القفل.`, suggestClosest('Relay',A,B));
    }
    if(c.type==='Power'){
      const ok = (hasRole(A,'power_out') && hasRole(B,'lock_power_in')) || (hasRole(B,'power_out') && hasRole(A,'lock_power_in'));
      if(!ok) add('err', `طاقة 12V غير صحيحة بين "${A.name}" و"${B.name}" — يجب من PSU (OUT) إلى القفل (IN).`, suggestClosest('Power',A,B));
    }
    const cross =
      ((A.network===NET.IP && c.type==='2Wire') || (B.network===NET.IP && c.type==='2Wire') ||
       (A.network===NET.TWO_WIRE && c.type==='Data') || (B.network===NET.TWO_WIRE && c.type==='Data'));
    if(cross) add('err', `لا تخلط 2‑Wire مع IP مباشرةً بين "${A.name}" و"${B.name}".`);
  }

  const plan = suggestPlan();
  for(const s of plan){ if(!hasEdgeLike(s)) add('warn', `موصى به: ${edgeText(s)}.`, ()=> addEdgeFromSuggestion(s)); }

  const strike = state.nodes.find(n=>n.type==='ElectricStrike');
  if(strike){
    const hasP = state.conns.some(e=> e.type==='Power' && (e.a===strike.id||e.b===strike.id));
    if(!hasP) add('err', 'القفل يحتاج تغذية 12V (PSU → Strike).', ()=>{
      const psu = state.nodes.find(n=>n.type==='PSU12V'); if(psu) addEdgeFromSuggestion({type:'Power', a:psu.id, b:strike.id});
    });
  }
  return msgs;
}

function hasEdgeLike(s){
  return state.conns.some(e=> (e.type===s.type) && ((e.a===s.a && e.b===s.b) || (e.a===s.b && e.b===s.a)) );
}

function edgeText(s){
  const A=nodeById(s.a), B=nodeById(s.b); return `${A?.name||'?'} ↔ ${B?.name||'?'} (${s.type})`;
}

function suggestClosest(type,A,B){
  return ()=>{
    const plan = suggestPlan().filter(x=>x.type===type);
    const cand = plan.find(x=>x.a===A.id||x.b===A.id) || plan.find(x=>x.a===B.id||x.b===B.id) || plan[0];
    if(cand) addEdgeFromSuggestion(cand);
  };
}

function addEdgeFromSuggestion(s){
  const id=uid();
  const meta = { pa: s.pa||portForType(nodeById(s.a), s.type, 'src'), pb: s.pb||portForType(nodeById(s.b), s.type, 'dst') };
  if(s.type==='Data' && (nodeById(s.a)?.type==='PoESwitch'||nodeById(s.b)?.type==='PoESwitch')) meta.poe=true;
  state.conns.push({id, a:s.a, b:s.b, type:s.type, length: s.length || 10, meta});
}

// ====== BOM ======
function buildBOM(){
  const dev=new Map(); const cab=new Map();
  const add=(k,q=1)=>dev.set(k,(dev.get(k)||0)+q);
  const addLen=(grp,len)=>cab.set(grp,(cab.get(grp)||0)+(Number(len)||0));
  for(const n of state.nodes) add(DEV[n.type].label);
  for(const c of state.conns) addLen(CABLE_GROUP[c.type]||'Other', c.length);
  return {
    devices: Array.from(dev.entries()).map(([item,qty])=>({item,qty})),
    cables: Array.from(cab.entries()).map(([type,meters])=>({type,meters:Math.round(meters*10)/10}))
  };
}

// ====== Render ======
function render(){
  const cnv=els.canvas, svg=els.svg; cnv.querySelectorAll('.node').forEach(n=>n.remove()); svg.querySelectorAll('g').forEach(g=>g.remove());
  if(state.plan){
    const plan=suggestPlan();
    for(const s of plan){
      const A=nodeById(s.a), B=nodeById(s.b); if(!A||!B) continue; const {cx:x1,cy:y1}=centerOf(A), {cx:x2,cy:y2}=centerOf(B);
      const g=document.createElementNS('http://www.w3.org/2000/svg','g');
      const p=document.createElementNS('http://www.w3.org/2000/svg','path'); p.setAttribute('d',`M ${x1},${y1} L ${x2},${y2}`); p.setAttribute('class','plan'); p.setAttribute('fill','none'); p.setAttribute('stroke-width','2'); svg.appendChild(g); g.appendChild(p);
    }
  }

  for(const n of state.nodes){
    const def=DEV[n.type];
    const div=document.createElement('div'); div.className='node'; div.style.left=n.x+'px'; div.style.top=n.y+'px'; div.style.width=def.w+'px'; div.style.height=def.h+'px'; div.style.background=def.color+'cc';
    if(state.selected===n.id) div.classList.add('sel');
    div.innerHTML=`<div class="t">${n.name}</div><div class="small">${def.label}</div>`;
    let dragging=false, dx=0, dy=0;
    div.onmousedown=(e)=>{ dragging=true; state.selected=n.id; const r=cnv.getBoundingClientRect(); dx=e.clientX-r.left-n.x; dy=e.clientY-r.top-n.y; renderPanels(); };
    document.addEventListener('mousemove', (e)=>{ if(!dragging) return; const r=cnv.getBoundingClientRect(); n.x=e.clientX-r.left-dx; n.y=e.clientY-r.top-dy; render(); saveLocal(); });
    document.addEventListener('mouseup', ()=> dragging=false);
    div.onclick=(e)=>{ e.stopPropagation(); if(state.pendingFrom && state.pendingFrom!==n.id){
      const type=els.connType.value; const length=Number(els.connLen.value)||0; const A=nodeById(state.pendingFrom), B=n;
      const meta={ pa:portForType(A,type,'src'), pb:portForType(B,type,'dst') };
      if(type==='Data' && (A.type==='PoESwitch'||B.type==='PoESwitch')) meta.poe=true;
      state.conns.push({id:uid(), a:A.id, b:B.id, type, length, meta});
      state.pendingFrom=null; renderAll(); saveLocal();
    } else { state.pendingFrom=n.id; renderChips(); } };
    cnv.appendChild(div);
  }

  for(const c of state.conns){
    const A=nodeById(c.a), B=nodeById(c.b); if(!A||!B) continue; const {cx:x1,cy:y1}=centerOf(A); const {cx:x2,cy:y2}=centerOf(B);
    const g=document.createElementNS('http://www.w3.org/2000/svg','g');
    const p=document.createElementNS('http://www.w3.org/2000/svg','path'); p.setAttribute('d',`M ${x1},${y1} L ${x2},${y2}`);
    p.setAttribute('fill','none'); p.setAttribute('stroke', COLORS[c.type]||'#9aa0a6'); p.setAttribute('stroke-width', state.simPath.has(c.id)? 5:3);
    if(c.type==='Relay') p.setAttribute('stroke-dasharray','6 4');
    if(c.type==='2Wire') p.setAttribute('stroke-dasharray','2 3');
    p.setAttribute('marker-end','url(#arrow)');
    g.appendChild(p);
    const t=document.createElementNS('http://www.w3.org/2000/svg','text'); t.setAttribute('x',(x1+x2)/2); t.setAttribute('y',(y1+y2)/2 - 6); t.setAttribute('text-anchor','middle'); t.setAttribute('class','small'); t.textContent = c.length? `${c.length}م` : '';
    g.appendChild(t);
    g.onmousemove=(e)=>{ showHint(e, hintForConn(c)); };
    g.onmouseleave=()=> els.hint.style.display='none';
    svg.appendChild(g);
  }
}

function hintForConn(c){
  const A=nodeById(c.a), B=nodeById(c.b);
  if(c.type==='Data') return `RJ45 568B: أبيض/برتقالي-برتقالي-أبيض/أخضر-أزرق-أبيض/أزرق-أخضر-أبيض/بني-بني`;
  if(c.type==='Power') return `12V: أحمر (+) → ${B.name}, أسود (−) → ${B.name}`;
  if(c.type==='Relay') return `Relay: NO + COM من ${A.name} إلى القفل (قصير المدى، سلكين)`;
  if(c.type==='2Wire') return `2‑Wire Bus: قطبية حسب دليل الجهاز (غالبًا +/−)`;
  return '';
}

function showHint(evt, text){ if(!state.teach) return; const b=els.canvas.getBoundingClientRect(); els.hint.style.left=(evt.clientX-b.left)+"px"; els.hint.style.top=(evt.clientY-b.top)+"px"; els.hint.textContent=text; els.hint.style.display='block'; }

function renderChips(){
  const cont=els.chips; cont.innerHTML='';
  if(state.pendingFrom){ const n=nodeById(state.pendingFrom); const span=document.createElement('div'); span.className='chip'; span.textContent=`توصيل من: ${n.name}`; cont.appendChild(span); }
}

function renderIssues(){
  const msgs=validate(); const ul=els.issues; ul.innerHTML='';
  if(msgs.length===0){ const li=document.createElement('li'); li.innerHTML='<span class="ok">لا توجد مشاكل حالياً ✔️</span>'; ul.appendChild(li); return; }
  for(const m of msgs){
    const li=document.createElement('li'); li.className = m.lvl==='err'? 'err' : 'warn';
    const btn = document.createElement('button'); btn.className='btn'; btn.textContent='إصلاح مقترح'; btn.style.marginInlineStart='8px';
    if(m.fix){ btn.onclick=()=>{ m.fix(); renderAll(); saveLocal(); }; } else { btn.disabled=true; }
    li.textContent='• '+m.text; li.appendChild(btn); ul.appendChild(li);
  }
}

function renderConnList(){
  const box=els.connsList; box.innerHTML='';
  for(const c of state.conns){
    const d=document.createElement('div'); d.className='chip'; const A=nodeById(c.a), B=nodeById(c.b);
    d.innerHTML=`<b>${c.type}</b> · ${A?.name||'?'} ↔ ${B?.name||'?'} · ${c.length||0}م <span class="small">(منافذ: ${c.meta?.pa||'?'}↔${c.meta?.pb||'?'})</span>`;
    const del=document.createElement('button'); del.className='btn'; del.style.padding='2px 6px'; del.style.marginInlineStart='6px'; del.textContent='حفظ'; del.style.display='none';
    const del2=document.createElement('button'); del2.className='btn'; del2.style.padding='2px 6px'; del2.style.marginInlineStart='6px'; del2.textContent='حذف';
    del2.onclick=()=>{ state.conns=state.conns.filter(x=>x.id!==c.id); renderAll(); saveLocal(); };
    d.appendChild(del2); box.appendChild(d);
  }
}

function renderBOM(){
  const bom=buildBOM(); els.bomDev.innerHTML=''; els.bomCab.innerHTML='';
  for(const r of bom.devices){ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.item}</td><td style="text-align:end">× ${r.qty}</td>`; els.bomDev.appendChild(tr); }
  for(const r of bom.cables){ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.type}</td><td style="text-align:end">${r.meters} م</td>`; els.bomCab.appendChild(tr); }
}

function renderPanels(){ renderIssues(); renderConnList(); renderBOM(); renderChips(); }
function renderAll(){ render(); renderPanels(); }

function buildToolbox(){
  const box=els.toolbox; box.innerHTML='';
  for(const [type,def] of Object.entries(DEV)){
    const b=document.createElement('button'); b.className='btn'; b.textContent=def.label; b.title=def.label; b.onclick=()=>{ const i=state.nodes.length; state.nodes.push({id:uid(), type, name:def.label, x:120+ (i%3)*220, y:140+ Math.floor(i/3)*150}); renderAll(); saveLocal(); };
    box.appendChild(b);
  }
}

els.canvas.onclick = ()=>{ state.pendingFrom=null; state.selected=null; renderChips(); render(); };

document.getElementById('deleteNode').onclick = ()=>{
  if(!state.selected) return; state.nodes = state.nodes.filter(n=>n.id!==state.selected); state.conns = state.conns.filter(c=>c.a!==state.selected && c.b!==state.selected); state.selected=null; renderAll(); saveLocal();
};

els.teachMode.onchange = (e)=>{ state.teach = e.target.checked; renderAll(); };
els.showPlan.onchange  = (e)=>{ state.plan  = e.target.checked; renderAll(); };
els.applyPlan.onclick  = ()=>{ const plan=suggestPlan(); for(const s of plan){ if(!hasEdgeLike(s)) addEdgeFromSuggestion(s); } renderAll(); saveLocal(); };

function simulate(){
  state.simPath.clear();
  const doors = state.nodes.filter(n=> ['DoorStationIP','DoorStation2W'].includes(n.type));
  const mons  = state.nodes.filter(n=> ['IndoorMonitorIP','IndoorMonitor2W'].includes(n.type));
  if(!doors.length||!mons.length){ renderAll(); return; }
  const start=doors[0].id, goal=mons[0].id;
  const adj = new Map(); for(const n of state.nodes) adj.set(n.id, []);
  for(const e of state.conns){ adj.get(e.a).push({to:e.b, id:e.id}); adj.get(e.b).push({to:e.a, id:e.id}); }
  const q=[start], vis=new Set([start]), prevEdge=new Map(), prevNode=new Map();
  while(q.length){ const u=q.shift(); if(u===goal) break; for(const nx of adj.get(u)){ if(!vis.has(nx.to)){ vis.add(nx.to); q.push(nx.to); prevEdge.set(nx.to, nx.id); prevNode.set(nx.to, u); } } }
  let cur=goal; while(prevEdge.has(cur)){ const eId=prevEdge.get(cur); state.simPath.add(eId); cur=prevNode.get(cur); }
  const strike = state.nodes.find(n=>n.type==='ElectricStrike');
  if(strike){ for(const e of state.conns){ if((e.type==='Relay'||e.type==='Power') && (e.a===strike.id || e.b===strike.id)) state.simPath.add(e.id); } }
  render();
}

document.getElementById('simulate').onclick = simulate;
document.getElementById('resetSim').onclick = ()=>{ state.simPath.clear(); render(); };

document.getElementById('exportBtn').onclick = ()=>{
  const data = JSON.stringify({nodes:state.nodes, conns:state.conns}, null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='intercom_wiring_v2.json'; a.click(); URL.revokeObjectURL(url);
};

document.getElementById('importFile').onchange = (e)=>{
  const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const o=JSON.parse(r.result); if(o.nodes&&o.conns){ state.nodes=o.nodes; state.conns=o.conns; renderAll(); saveLocal(); } }catch(err){ alert('ملف غير صالح'); } }; r.readAsText(f);
};

document.getElementById('presetIP').onclick = ()=>{ const p=presetIPPoe(); state.nodes=p.nodes; state.conns=p.conns; state.selected=null; state.pendingFrom=null; state.simPath.clear(); renderAll(); saveLocal(); };
document.getElementById('preset2W').onclick = ()=>{ const p=preset2Wire(); state.nodes=p.nodes; state.conns=p.conns; state.selected=null; state.pendingFrom=null; state.simPath.clear(); renderAll(); saveLocal(); };

(function init(){ buildToolbox(); loadLocal(); if(!state.nodes.length){ const p=presetIPPoe(); state.nodes=p.nodes; state.conns=p.conns; } renderAll(); })();
</script>
</body>
</html>
