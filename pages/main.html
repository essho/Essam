<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>واجهة تفاعلية — عصام الكهربائي (بدون خلفية 360)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <style>
    :root{ --ep-panel: rgba(10,14,20,0.65); --ep-ring: rgba(0,229,255,0.35); --ep-accent:#00e5ff; --ep-bulb:#ffd166; }
    body { margin: 0; background:#000; color:#e8eef6; font-family: system-ui,-apple-system,Segoe UI,Roboto,"Noto Naskh Arabic UI",Tahoma,Arial,sans-serif; }
    .ep-scene-ui{ position:fixed; inset:0; pointer-events:none; }
    .ep-strip{ position:absolute; inset-inline:0; inset-block-end:max(10px,3vh); pointer-events:auto; overflow:hidden; }
    .ep-track{ display:flex; flex-wrap:nowrap; gap:12px; will-change:transform; }
    .ep-thumb{ flex:0 0 auto; width:clamp(120px, 20vw, 200px); height:clamp(150px, 26vw, 220px);
      border-radius:16px; overflow:hidden; position:relative; cursor:pointer;
      border:1px solid rgba(255,255,255,.08); box-shadow:0 10px 40px rgba(0,0,0,.5), 0 0 0 5px rgba(255,255,255,.03) inset;
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.01)); display:grid; place-items:end stretch;
      transition:transform .16s ease, box-shadow .25s ease;
    }
    .ep-thumb:hover{ transform:translateY(-4px) scale(1.08); box-shadow:0 12px 46px rgba(0,0,0,.55), 0 0 0 10px rgba(255,255,255,.03) inset; z-index:2; }
    .ep-thumb img{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; filter:saturate(.95) contrast(1.05) brightness(.9); }
    .ep-thumb .label{ position:relative; z-index:1; padding:8px 10px; font-size:.9rem; background:linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.55)); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .ep-center{ position:absolute; inset:0; display:grid; place-items:center; pointer-events:none; }
    .ep-actions{ display:flex; gap:10px; pointer-events:auto; }
    .ep-power{ --s:clamp(64px,10vw,100px); width:var(--s); height:var(--s); border-radius:999px; border:1px solid rgba(255,255,255,.1);
      background: radial-gradient(circle at 35% 30%, rgba(255,255,255,.08), rgba(255,255,255,.02)), var(--ep-panel);
      color:var(--ep-accent); cursor:pointer; outline:none; display:grid; place-items:center; position:relative;
      box-shadow:0 8px 30px rgba(0,0,0,.45), 0 0 0 6px var(--ep-ring); transition:transform .12s ease, box-shadow .25s ease, background .3s ease; }
    .ep-power:hover{ transform: translateY(-2px) scale(1.02); box-shadow:0 10px 36px rgba(0,0,0,.5), 0 0 0 10px var(--ep-ring); }
    .ep-power svg{ width:55%; height:55%; }
    .ep-power:active{ transform: translateY(0) scale(.99); }
    body.ep-on .ep-power{ color:#111; background: radial-gradient(circle at 35% 30%, rgba(255,255,255,.2), rgba(255,255,255,.05)), linear-gradient(180deg, var(--ep-bulb) 0%, var(--ep-bulb) 30%, #ffe39b 100%); box-shadow:0 10px 40px rgba(255,209,102,.35), 0 0 0 10px rgba(255,209,102,.15) }
    .ep-bulb{ position:absolute; top:-30px; left:50%; transform:translateX(-50%); width:120px; height:200px; z-index:1; pointer-events:none; }
    .ep-bulb .cord{ position:absolute; top:-70vh; left:50%; transform:translateX(-50%); width:3px; height:80vh; background:linear-gradient(#222,#111); box-shadow:0 0 0 1px rgba(255,255,255,.05) inset; }
    .ep-bulb .glass{ position:absolute; bottom:0; left:50%; transform:translateX(-50%); width:120px; height:140px; border-radius:60% 60% 50% 50% / 60% 60% 40% 40%; background: radial-gradient(120px 90px at 50% 45%, rgba(255,255,255,.06), rgba(255,255,255,0)), linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03)); border:2px solid rgba(255,255,255,.12); box-shadow:0 12px 40px rgba(0,0,0,.6); }
    .ep-bulb .filament{ position:absolute; bottom:68px; left:50%; transform:translateX(-50%); width:62px; height:34px; border-radius:40px; border:3px solid rgba(255,209,102,.15); filter:drop-shadow(0 0 0 rgba(255,209,102,0)); transition:all .25s ease; }
    .ep-glow{ position:absolute; bottom:-30px; left:50%; transform:translateX(-50%); width:300px; height:300px; border-radius:50%; pointer-events:none; opacity:0; background: radial-gradient(circle, rgba(255,209,102,.45), rgba(255,209,102,.02) 60%, transparent 70%); filter:blur(8px); transition:opacity .35s ease; }
    body.ep-on .ep-bulb .filament{ border-color: rgba(255,209,102,.9); filter: drop-shadow(0 0 8px rgba(255,209,102,.8)); }
    body.ep-on .ep-glow{ opacity:1; }
    .ep-bulb .mute-btn{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:44px; height:44px; border-radius:999px; border:1px solid rgba(255,255,255,.35); background:rgba(0,0,0,.45); color:#fff; display:grid; place-items:center; font-size:20px; cursor:pointer; pointer-events:auto; box-shadow:0 10px 30px rgba(0,0,0,.45); }

    .ep-overlay{ position:fixed; inset:0; z-index:1001; background:rgba(0,0,0,.25); display:grid; place-items:center; opacity:0; pointer-events:none; transition:opacity .2s ease; }
    .ep-overlay.open{ opacity:1; pointer-events:auto; }
    .ep-modal{ width:min(820px,92vw); background:rgba(16,20,28,.25); border:1px solid rgba(255,255,255,.18); border-radius:18px; padding:clamp(18px,3vw,28px); box-shadow:0 30px 120px rgba(0,0,0,.35), 0 0 0 10px rgba(255,255,255,.02) inset; backdrop-filter: blur(10px); transform:translateY(10px) scale(.98); transition:transform .25s ease; position:relative; }
    .ep-view{ position:fixed; inset:0; z-index:1002; background:rgba(0,0,0,.75); display:grid; grid-template-rows:auto 1fr; opacity:0; pointer-events:none; transition:opacity .2s ease; }
    .ep-view.open{ opacity:1; pointer-events:auto; }
    .ep-bar{ display:flex; align-items:center; justify-content:center; padding:8px 12px; background:rgba(10,14,20,.85); border-bottom:1px solid rgba(255,255,255,.08); }
    .ep-bar .btn{ padding:.6rem 1.1rem; border-radius:999px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.03); color:#e8eef6; cursor:pointer; }
    .ep-bar .btn:hover{ background:rgba(255,255,255,.06); }
    .ep-frame{ border:0; width:100%; height:100%; background:#0b0f14; }
  </style>
</head>
<body>

  <!-- A-Frame Scene for 360 video/images -->
  <a-scene id="main-scene">
    <a-assets>
      <video id="video360" src="videos/my_360_video.mp4"
             crossorigin="anonymous"
             playsinline webkit-playsinline
             preload="auto"></video>

      <img id="pano1" src="images/pano1.jpg">
      <img id="pano1" src="images/pano2.jpg">
      <img id="pano1" src="images/pano3.jpg">
      <img id="pano1" src="images/pano4.jpg">
      <img id="pano1" src="images/pano5.jpg">
      <img id="pano1" src="images/pano6.jpg">
      <img id="pano1" src="images/pano7.jpg">
      <img id="pano1" src="images/pano8.jpg">
      <img id="pano1" src="images/pano9.jpg">
      <img id="pano1" src="images/pano10.jpg">
      <img id="pano1" src="images/pano11.jpg">
    </a-assets>

    <!-- Background -->
    <a-sky id="sky" material="shader: flat" src="#video360"></a-sky>

    <!-- Reflective sphere -->
    <a-sphere id="eyeSphere" radius="1" position="0 4.0 -3"
              material="shader: flat; side: back; src:#video360"></a-sphere>

    <a-entity position="0 1.6 0">
      <a-camera look-controls="reverseMouseDrag: true" wasd-controls-enabled="false"></a-camera>
    </a-entity>
  </a-scene>

  <audio id="bgSound" loop><source src="background_music.mp3"> المتصفح لا يدعم تشغيل الصوت.</audio>

  <div class="ep-scene-ui" aria-hidden="false">
    <div class="ep-strip" id="epStrip"><div class="ep-track" id="epTrack"></div></div>

    <div class="ep-center">
      <div class="ep-bulb">
        <div class="cord"></div><div class="glass"></div><div class="filament"></div>
        <button class="mute-btn" id="epBulbMute" title="كتم/تشغيل الصوت">🔊</button>
        <div class="ep-glow"></div>
      </div>
      <div class="ep-actions">
        <button id="epPower" class="ep-power" aria-haspopup="dialog" aria-controls="epAbout" aria-expanded="false" title="تشغيل">
          <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M11 3h2v10h-2z"></path><path d="M7.05 7.05a7 7 0 109.9 0l-1.41 1.41a5 5 0 11-7.07 0L7.05 7.05z"></path></svg>
        </button>
      </div>
    </div>
  </div>

  <div class="ep-overlay" id="epOverlay" hidden>
    <div class="ep-modal" role="dialog" aria-modal="true" aria-labelledby="epTitle">
      <button class="ep-close" id="epClose" aria-label="إغلاق">×</button>
      <h2 id="epTitle">تعريف سريع</h2>
      <p>أهلاً بيك! أنا <strong>محمد</strong> فني/مهندس كهرباء…</p>
    </div>
  </div>

  <div class="ep-view" id="epView" hidden>
    <div class="ep-bar"><button class="btn" id="epBackBar">عودة</button></div>
    <iframe class="ep-frame" id="epFrame" title="عرض الصفحة"></iframe>
  </div>

  <script>
    const video = document.querySelector('#video360');
    const sky = document.querySelector('#sky');
    const eye = document.querySelector('#eyeSphere');
    const mainScene = document.getElementById('main-scene');

    // Photos after the video
    const images = ['#pano1','#pano2','#pano3'];

    // Duration of the full rotation in milliseconds
    const rotationDuration = 15000;

    let currentIndex = 0;

    // Listen for the video to end before starting the image loop
    video.addEventListener('ended', () => {
      startLoop();
    });

    // Starts the image loop
    function startLoop(){
      currentIndex = 0;
      showNext();
    }

    // Displays the next image and rotates it
    function showNext(){
      const src = images[currentIndex];
      sky.setAttribute('src', src);
      eye.setAttribute('material', 'shader: flat; side: back; src:' + src);
      animateRotation(rotationDuration, () => {
        currentIndex = (currentIndex + 1) % images.length;
        showNext();
      });
    }

    // Animates the rotation smoothly
    function animateRotation(duration, onComplete){
      let start = null;
      function step(timestamp){
        if (!start) start = timestamp;
        let progress = timestamp - start;
        let ratio = Math.min(progress / duration, 1);
        let angle = ratio * 360;
        sky.setAttribute('rotation', `0 ${angle} 0`);
        eye.setAttribute('rotation', `0 ${-angle} 0`);
        if (progress < duration){
          requestAnimationFrame(step);
        } else {
          if (onComplete) onComplete();
        }
      }
      requestAnimationFrame(step);
    }

    var bgSound = document.getElementById('bgSound');

    // تفعيل الصوت بعد أول تفاعل فقط (اختياري)
    function unlockAudioOnce(){
      try{ bgSound.play().catch(function(){}); }catch(e){}
      window.removeEventListener('pointerdown', unlockAudioOnce);
      window.removeEventListener('touchstart', unlockAudioOnce);
      window.removeEventListener('keydown', unlockAudioOnce);
    }
    window.addEventListener('pointerdown', unlockAudioOnce);
    window.addEventListener('touchstart', unlockAudioOnce);
    window.addEventListener('keydown', unlockAudioOnce);

    (function(){
      function $(id){ return document.getElementById(id); }
      var body = document.body, powerBtn = $('epPower'), overlay = $('epOverlay'), closeModal = $('epClose');
      var viewOverlay = $('epView'), viewFrame = $('epFrame'), btnBackBar = $('epBackBar'), btnBulbMute = $('epBulbMute');
      var epStrip = $('epStrip'), epTrack = $('epTrack');

      powerBtn.addEventListener('click', function(){ body.classList.add('ep-on'); openAbout(); });
      function openAbout(){ overlay.hidden=false; setTimeout(function(){ overlay.classList.add('open'); },0); powerBtn.setAttribute('aria-expanded','true'); }
      function closeAbout(){ overlay.classList.remove('open'); powerBtn.setAttribute('aria-expanded','false'); setTimeout(function(){ overlay.hidden=true; body.classList.remove('ep-on'); },180); }
      overlay.addEventListener('click', function(e){ if(e.target===overlay) closeAbout(); });
      closeModal.addEventListener('click', closeAbout);
      window.addEventListener('keydown', function(e){ if(e.key==='Escape' && overlay.classList.contains('open')) closeAbout(); });

      function isSameOrigin(url){ var a=document.createElement('a'); a.href=url; return a.origin===location.origin; }
      function tidyName(name){ try{ name = decodeURIComponent(name); }catch(e){} name = name.replace(/\.(html?|htm)$/i,''); name = name.replace(/[-_]+/g,' ').trim(); return name || 'صفحة'; }
      function computeLabelText(href, title){
        if(title && title.trim()) return tidyName(title.trim());
        var u = href.split('#')[0].split('?')[0]; u = u.replace(/\/+$/,''); u = u.split('/').pop(); return tidyName(u);
      }
      function sameUrl(a, b){
        function norm(u){ var x=document.createElement('a'); x.href=u; var p=x.pathname.replace(/index\.(html?|htm)$/i,''); return (x.protocol+'//'+x.host+p).replace(/\/+$/,'/'); }
        return norm(a)===norm(b);
      }
      function resolveUrl(href, base){ var a=document.createElement('a'); a.href=base||location.href; var b=document.createElement('a'); b.href=href; if(b.href.indexOf('http')===0) return b.href; a.pathname=a.pathname.replace(/[^\/]*$/,''); b.href=a.href+href; return b.href; }

      function xhrJSON(url){ return new Promise(function(res,rej){ var x=new XMLHttpRequest(); x.open('GET',url,true); x.onreadystatechange=function(){ if(x.readyState===4){ if(x.status>=200&&x.status<300){ try{ res(JSON.parse(x.responseText)); }catch(e){ rej(e); } } else rej(new Error('HTTP '+x.status)); } }; x.onerror=rej; x.send(); }); }
      function xhrTEXT(url){ return new Promise(function(res,rej){ var x=new XMLHttpRequest(); x.open('GET',url,true); x.onreadystatechange=function(){ if(x.readyState===4){ if(x.status>=200&&x.status<300){ res(x.responseText); } else rej(new Error('HTTP '+x.status)); } }; x.onerror=rej; x.send(); }); }

      function discoverThumbViaMeta(url){
        if(!isSameOrigin(url)) return Promise.resolve('');
        return xhrTEXT(url).then(function(html){
          var tmp=document.createElement('div'); tmp.innerHTML=html;
          var og=tmp.querySelector('meta[property=\"og:image\"],meta[name=\"twitter:image\"]');
          if(og && og.getAttribute('content')) return resolveUrl(og.getAttribute('content'), url);
          var img=tmp.querySelector('img[src]'); if(img) return resolveUrl(img.getAttribute('src'), url);
          return '';
        }).catch(function(){ return ''; });
      }
      function screenshotSameOrigin(url){
        if(!isSameOrigin(url) || !window.html2canvas) return Promise.resolve('');
        return new Promise(function(res){
          var ifr = document.createElement('iframe');
          var done=false;
          function cleanup(){ if(ifr && ifr.parentNode) ifr.parentNode.removeChild(ifr); }
          var to = setTimeout(function(){ if(!done){ done=true; cleanup(); res(''); } }, 3500);
          ifr.style.position='fixed'; ifr.style.left='-200vw'; ifr.style.top='-200vh'; ifr.width=800; ifr.height=600;
          ifr.onload=function(){
            if(done) return; done=true;
            try{
              window.html2canvas(ifr.contentWindow.document.body, {useCORS:true, scale:0.35}).then(function(canvas){
                cleanup(); clearTimeout(to); res(canvas.toDataURL('image/jpeg', 0.75));
              }).catch(function(){ cleanup(); clearTimeout(to); res(''); });
            }catch(e){ cleanup(); clearTimeout(to); res(''); }
          };
          try{ ifr.src=url; document.body.appendChild(ifr); }catch(e){ res(''); }
        });
      }

      function filterOutSelf(list){
        var here = location.href, out=[];
        for(var i=0;i<list.length;i++){ var abs = resolveUrl(list[i].href, location.href); if(!sameUrl(abs, here)) out.push({href:abs, title:list[i].title||'', thumb:list[i].thumb||''}); }
        return out;
      }

      function getPages(){
        return xhrJSON('pages.json').then(function(data){ return filterOutSelf(data||[]); })
          .catch(function(){
            var dirUrl = location.href.replace(/[^\/]*$/,'');
            return xhrTEXT(dirUrl).then(function(html){
              var tmp=document.createElement('div'); tmp.innerHTML=html;
              var as=tmp.querySelectorAll('a[href]'); var items=[];
              for(var i=0;i<as.length;i++){ var h=as[i].getAttribute('href'); if(h && /\.html?$/i.test(h)){ var abs=resolveUrl(h, dirUrl); if(abs.indexOf('prototype')===-1) items.push({href:abs, title:h.replace(/.*\//,''), thumb:''}); } }
              return filterOutSelf(items);
            }).catch(function(){
              var fallback=[{href:'index.html', title:'الرئيسية', thumb:'assets/thumbs/home.jpg'},
                            {href:'work-panel.html', title:'لوحة توزيع', thumb:'assets/thumbs/panel.jpg'},
                            {href:'work-led.html', title:'ترقية LED', thumb:'assets/thumbs/led.jpg'}];
              return filterOutSelf(fallback);
            });
          });
      }

      function buildThumbData(pages){
        var jobs = pages.map(function(p){
          var href = p.href, label = computeLabelText(href, p.title);
          if(p.thumb){ return Promise.resolve({href:href, label:label, thumb:p.thumb}); }
          return discoverThumbViaMeta(href).then(function(t){ if(t) return t; return screenshotSameOrigin(href); }).then(function(t){ return {href:href, label:label, thumb:t||''}; });
        });
        return Promise.all(jobs);
      }

      function makeThumbEl(data){
        var el=document.createElement('div'); el.className='ep-thumb'; el.setAttribute('data-href', data.href); el.setAttribute('data-label', data.label);
        if(data.thumb){ var img=document.createElement('img'); img.alt=data.label; img.src=data.thumb; el.appendChild(img); }
        var label=document.createElement('div'); label.className='label'; label.textContent=data.label; el.appendChild(label);
        return el;
      }

      function fillTrackWithData(data){
        epTrack.innerHTML='';
        var need = epStrip.clientWidth * 2, safety=0;
        while(epTrack.scrollWidth < need && safety++ < 30){
          for(var i=0;i<data.length;i++){ epTrack.appendChild(makeThumbEl(data[i])); }
        }
      }

      function startTicker(){
        var x = 0, last = 0, speed = 50;
        function getGap(){ var cs = window.getComputedStyle(epTrack); return parseFloat(cs.gap || cs.columnGap || cs.rowGap) || 0; }
        function step(ts){
          if(!last) last=ts;
          var dt=(ts-last)/1000; last=ts;
          x -= speed*dt;
          epTrack.style.transform = 'translateX(' + x + 'px)';
          var first = epTrack.firstElementChild;
          while(first){
            var moveBy = first.offsetWidth + getGap();
            if(-x >= moveBy){
              x += moveBy;
              epTrack.style.transform = 'translateX(' + x + 'px)';
              epTrack.appendChild(first);
              first = epTrack.firstElementChild;
            }else break;
          }
          requestAnimationFrame(step);
        }
        requestAnimationFrame(step);

        epTrack.addEventListener('click', function(e){
          var t = e.target.closest('.ep-thumb'); if(!t) return;
          openPage({href:t.getAttribute('data-href'), title:t.getAttribute('data-label')});
        });
      }

      (function initStripOnce(){
        getPages().then(buildThumbData).then(function(data){
          fillTrackWithData(data);
          startTicker();
        }).catch(function(err){
          console.error('خطأ في تجهيز الشريط:', err);
        });
      })();

      function openPage(item){ viewFrame.src=item.href; viewOverlay.hidden=false; setTimeout(function(){ viewOverlay.classList.add('open'); },0); }
      function closePage(){ viewOverlay.classList.remove('open'); setTimeout(function(){ viewOverlay.hidden=true; viewFrame.src='about:blank'; },180); }
      btnBackBar.addEventListener('click', closePage);
      viewOverlay.addEventListener('click', function(e){ if(e.target===viewOverlay) closePage(); });

document.addEventListener('DOMContentLoaded', () => {
  const video = document.getElementById('video360');
  if (video) {
    video.muted = true;      // مهم عشان أغلب المتصفحات بتسمح بالأوتوبلاي لو الفيديو مكتوم
    video.play().catch(() => {});
  }
});

      var isMuted = false;
      function setMuted(m){ isMuted = m; try{ if(isMuted){ bgSound.pause(); } else { bgSound.play().catch(function(){}); } }catch(e){}; btnBulbMute.textContent = isMuted ? '🔇' : '🔊'; }
      btnBulbMute.addEventListener('click', function(e){ e.stopPropagation(); setMuted(!isMuted); });
      setMuted(false);
    })();
  </script>
</body>
</html>
